
Coffium::CORE
=============

Назначение и границы ядра
-------------------------

### Состав ядра

- ```/libs``` - библиотеки ядра
- ```.htaccess``` - перенаправление запросов на index.php
- ```config-*.php``` - файлы конфигурации системы, окружения и проекта
- ```index.php``` - точка входа в обработку запроса

### Задачи ядра (жизненный цикл запроса)

1) перенаправление всех запросов на ```index.php``` ```(.htaccess)```
2) инициализация системы ```(config-*.php)```
3) организация системного реестра ```($SYS, /libs/inc.registry.php)```
4) анализ запроса ```(/libs/inc.request.php)```
6) маршрутизация: реализация зависимостей, инициализация компонентов и запуск обработчиков ```(/libs/inc.response.php)```
7) финализация

### Чего ядро НЕ делает

Ядро Coffium минималистично. Предполагается, что вся дополнительная функциональность реализуется исключительно через компоненты. Таким образом:

- ядро не кеширует
- ядро не блокирует
- ядро не работает с БД
- ядро не шаблонизирует
- ядро не имеет хуков (кроме финализаторов)
- ядро не имеет административного интерфейса
- не печет тортики и не вышивает крестиком


Перенаправление запросов
------------------------

С помощью .htaccess все запросы перенаправляются на ```index.php```

Исключения:
- ```favicon.ico```
- ```robots.txt```
- ```/web``` каталоги в дереве компонентов ```/coms```

При необходимости список исключений может быть расширен.


Инициализация системы
---------------------

### config-global.php

Глобальная конфигурация определяет параметры ядра, системы, PHP и спец. доступа.

#### ML_URL_SUPPORT = <True|False>

Поддержка URL-мультиязычности.

```True``` - маршрутизатор отбрасывает первый сегмент URL-пути при построении ```route.path```. Например, при запросе:

```https://<server>/de/home/```

сегмент ```de``` игнорируется, а маршрутизатор ищет обработчик страницы в корне компонента: ```/coms/home```

Этот флаг обеспечивает работу механизма URL-мультиязычности. Подразумевается, что первый (игнорируемый) сегмент используется компонентом мультиязычности (например, ```mlang```) для определения текущего языка и подключения соответствующего словаря с переводами.

```False``` - обычная маршрутизация, при которой первый сегмент учитывается. Следует использовать в одноязычных проектах или, при использовании другого механизма мультиязычности, например, управление языками через GET/POST параметры.

#### ML_DIR_SUPPORT = <True|False>

```True``` - подключение языковых файлов (словарей) из каталогов ```/_lang``` от корня компонентов до каталога обработчика.

Например, для обработчика ```/coms/help/contents/``` будут подключены все PHP файлы из следующих каталогов (включая вложенные папки, если они есть в каталогах ```/_lang```):
```
/coms/_lang
/coms/help/_lang
/coms/help/contents/_lang
```

Это сделано, чтобы можно было располагать словари с переводами по месту их использования и, при необходимости, структурировать тематически.

Предполагается, что подключаемые файлы содержат массив с именем ```$DICTIONARY```. Формат массивов (словарей) должен быть согласован с компонентом мультиязычности (например, ```mlang```).

```False``` - если используется кастомный механизм реализации мультиязычности, например, суперсловари (глобальные словари в корне проекта или в корне каждого компонента).

ПОДСКАЗКА: компонент с переводами может работать без компонента мультиязычности, с помощью API-заглушки:

```php
if (!function_exists('ml')) {
    function ml($text) { return $text; }
}
```

При этом сообщения выводятся как есть.

#### Тип сервера (IS_CRON|IS_LOCAL|IS_DEV|IS_PROD)

С помощью флагов ```IS_CRON|IS_LOCAL|IS_DEV|IS_PROD``` можно определять сервер-зависимую логику. Флаги устанавливаются автоматически.

ВНИМАНИЕ: поскольку в каждой организации dev-сервер реализуется по-своему (локально, на внешнем сервере, на субдомене, в другой доменной зоне и т.д.), следует уточнить признаки флага ```IS_DEV```.

SERVER_TYPE = Local|Development|Production + суффикс -Cron для CLI/cron.

#### Системные пути и URL-адреса

```TIME_HASH``` - динамический хеш на базе текущего времени и типа сервера.

По умолчанию, для ```LOCAL``` & ```DEV``` сервера обновляется каждую секунду, а для ```PROD``` сервера раз каждый час (можно увеличить до суток или месяца).
Это значение удобно использовать в качестве ```GET``` параметра для принудительной перезагрузки статики в браузере (стилей, скриптов и картинок). Например:

```php
<link href="https://<server>/home/web/s/default.css?v=<?=TIME_HASH?>" rel="stylesheet" type="text/css">
```

```PROJ_ROOT``` - абсолютный путь к корню системы/проекта, определяется как каталог, в котором находится данный файл конфигурации. Это позволяет располагать систему не только в корне сервера, но и в подкаталогах.

COMS_PATH|COMS_ROOT - корневой каталог компонентов
LOGS_PATH|LOGS_ROOT - корневой каталог лог-файлов
TEMP_PATH|TEMP_ROOT - корневой каталог временных файлов

#### Конфигурация PHP

Этот раздел глобальной конфигурации включает в себя PHP настройки времени, безопасности, компрессии, сессии, логирования и кодировки. Описание соответствующих функций, параметров и значений можно найти в документации PHP.

#### VIP доступ

VIP режим целесообразно использовать для получения доступа к инструментам отладки и разработки, а также для временного скрытия от клиентов частей проекта, находящихся в разработке.

VIP_MODE_KEY - определяет GET/POST ключ, с помощью которого можно управлять VIP доступом

ВНИМАНИЕ: значение ключа VIP_MODE_KEY следует обязательно изменить!

Для активации VIP доступа нужно к любому URL проекта добавить GET параметр с заданным ключом и значением <1|on|yes|true>. Например, если ключ указан как "projkeeper", то URL будет:

```https://<server>/home/?projkeeper=on```

Это установит в сессии флаг $_SESSION['core.vip_access'], и режим VIP доступа будет работать до отключения, или пока не будет сброшена сессия. Выключить этот режим можно таким же способом, указав любое другое значение, например:

```https://<server>/home/?projkeeper=off```

Для удобства работы создается константа IS_VIP, с помощью которой в любом месте проекта можно проверить состояние данного режима доступа.
Пример использования VIP доступа:

```php
if (!IS_VIP) redirect('/home/');
```

### config-server.php

Определяет сервер-зависимую конфигурацию: учетные данные к БД и другие параметры, которые различаются между окружениями `LOCAL`, `DEV`, `PROD` и задачами `CRON`.

### config-custom.php

Содержит настройки, специфичные для проекта. Используется для централизованного управления конфигурацией без правок отдельных конфигов внутри компонентов.

РЕКОМЕНДАЦИЯ: компоненты дублируют параметры с проверкой на предварительное определение, например:

```php
if (!defined('APP_FEATURE_X_ENABLED')) {
    define('APP_FEATURE_X_ENABLED', 'default_value');
}
```

Это позволяет безопасно комментировать или удалять значения в config-custom.php: при отсутствии константы компонент подставит значение по умолчанию.

Системный реестр
----------------

Системный реестр реализован как глобальный массив $SYS и набор функций для работы с ним. API реестра описан в файле: ```/libs/inc.registry.php```.

Назначение реестра - централизованное хранение данных системы при обработке текущего запроса. Это упрощает межкомпонентное взаимодействие и отладку.

Для именования ключей реестра следует использовать следующее соглашение:

```компонент.параметр```

или

```компонент.подсистема.параметр```

Исключение: ядро системы добавляет ключи без префикса.

**ВАЖНО:** Следует использовать исключительно API доступа к реестру, поскольку в следующих версиях ядра, с целью повышения безопасности и стабильности, глобальная переменная будет скрыта из глобальной области видимости.

Анализ запроса
--------------


Автозапуск компонентов
----------------------


Маршрутизация и реализация зависимостей
---------------------------------------


Финализация
-----------


Отладка и VIP режим
-------------------

